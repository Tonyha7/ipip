<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>美团团定位</title>
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #input-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 999;
            background: white;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        input[type="text"] {
            padding: 8px;
            margin-right: 10px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #357abd;
        }
        #result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            display: none;
        }
        .error {
            color: #dc3545;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="input-panel">
        <input type="text" id="ip-input" placeholder="请输入IPv4地址" />
        <button onclick="searchIP()">查询位置</button>
        <button onclick="getCurrentIP()">获取当前IP</button>
        <div id="ip-error" class="error"></div>
        <div id="result"></div>
    </div>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "6fc7a031b815e608a96c4b8d79f817bf",
        };
    </script>
    <script src="https://webapi.amap.com/loader.js"></script>
    <script type="text/javascript">
        let map;
        let marker;
        const BEIJING_COORDS = [116.39072, 39.91658]; // 北京故宫坐标 [经度, 纬度]

        // IP地址验证函数
        function isValidIPv4(ip) {
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipv4Regex.test(ip)) return false;
            
            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        // 获取当前IP
        async function getCurrentIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                const ip = data.ip;
                
                if (isValidIPv4(ip)) {
                    document.getElementById('ip-input').value = ip;
                    document.getElementById('ip-error').style.display = 'none';
                    searchIP();
                } else {
                    document.getElementById('ip-error').textContent = '检测到IPv6地址，请输入IPv4地址';
                    document.getElementById('ip-error').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('ip-error').textContent = '获取IP地址失败';
                document.getElementById('ip-error').style.display = 'block';
            }
        }

        async function searchIP() {
            const ipInput = document.getElementById('ip-input').value;
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('ip-error');
            
            if (!isValidIPv4(ipInput)) {
                errorDiv.textContent = '请输入有效的IPv4地址';
                errorDiv.style.display = 'block';
                resultDiv.style.display = 'none';
                return;
            }
            
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch(`https://iploc.api.tonyha7.com/?ip=${ipInput}`);
                const data = await response.json();
                
                // 显示结果
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    位置信息：${data.country} ${data.province} ${data.city} ${data.district}
                    <br>经度：${data.lng} 纬度：${data.lat}
                `;

                const position = [data.lng, data.lat]; // 高德地图使用 [经度, 纬度] 格式
                
                // 如果已有标记则移除
                if (marker) {
                    map.remove(marker);
                }

                // 添加新标记
                marker = new AMap.Marker({
                    position: position,
                    map: map,
                    label: {
                        content: `${data.city}`,
                        direction: 'top'
                    }
                });

                // 将地图中心移动到新位置
                map.setCenter(position);

                // 添加信息窗体
                const infoWindow = new AMap.InfoWindow({
                    content: `
                        <div>
                            <h4>${data.country} ${data.province} ${data.city}</h4>
                            <p>${data.district}</p>
                            <p>经度：${data.lng}</p>
                            <p>纬度：${data.lat}</p>
                        </div>
                    `,
                    offset: new AMap.Pixel(0, -30)
                });

                marker.on('click', () => {
                    infoWindow.open(map, position);
                });
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '查询失败，请检查IP地址是否正确';
            }
        }

        // 使用 AMapLoader 加载和初始化地图
        AMapLoader.load({
            key: "a1cfd68400e31dc19dc2bbb678577a32",           // 申请好的Web端开发者Key
            version: "2.0",              // 指定要加载的 JSAPI 的版本
            plugins: [                   // 需要使用的的插件列表
                'AMap.ToolBar',
                'AMap.Scale',
                'AMap.HawkEye',
                'AMap.MapType',
                'AMap.Geolocation'
            ]
        }).then((AMap) => {
            // 创建地图实例
            map = new AMap.Map("container", {
                zoom: 12,                // 初始缩放级别
                center: BEIJING_COORDS,  // 初始地图中心点
            });

            // 添加控件
            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.Scale());
            map.addControl(new AMap.HawkEye({isOpen: true}));
            map.addControl(new AMap.MapType());
            map.addControl(new AMap.Geolocation());

            // 添加故宫标记
            new AMap.Marker({
                position: BEIJING_COORDS,
                map: map,
                title: '北京故宫',
                label: {
                    content: '故宫',
                    direction: 'top'
                }
            });

            // 页面加载时自动获取IP
            getCurrentIP();
        }).catch((e) => {
            console.error(e);  //加载错误提示
        });
    </script>
</body>
</html>
